#include "web_audio/detail/upsampler.hh"

#include "web_audio/detail/math_helper.hh"
#include "web_audio/detail/wave_processing.hh"

namespace web_audio::detail {
Upsampler::Upsampler(const std::vector<float> &filterCoefficients,
                     std::size_t factor, std::size_t blockSize)
    : factor_(factor), inputBlockSize_(blockSize) {
  filterCoefficients_ = filterCoefficients;

  outputBlockSize_ = inputBlockSize_ * factor_;
  filterSize_ = filterCoefficients_.size();
  fftSize_ = MathHelper::nextPowerOfTwo(outputBlockSize_ + filterSize_ - 1);
  filterCoefficients_.resize(fftSize_, 0.0f);
  fftCoefficientsFrequency_.resize(fftSize_);
  overlapBuffer_.resize(filterSize_ - 1, std::complex<float>(0.0f, 0.0f));

  WaveProcessing::fourierTransform(filterCoefficients_,
                                   fftCoefficientsFrequency_);
}

void Upsampler::process(const std::vector<float> &input,
                        std::vector<float> &output) {
  if (input.size() != inputBlockSize_) {
    throw std::invalid_argument("Input size must be equal to block size.");
  }

  output.resize(outputBlockSize_);

  std::vector<float> inputPadded(fftSize_, 0.0f);

  for (std::size_t i = 0; i < inputBlockSize_; ++i) {
    inputPadded[i * factor_] = input[i];
  }

  std::vector<std::complex<float>> inputFrequency(fftSize_);
  WaveProcessing::fourierTransform(inputPadded, inputFrequency);

  std::vector<std::complex<float>> outputFrequency(fftSize_);

  for (std::size_t i = 0; i < fftSize_; ++i) {
    outputFrequency[i] = inputFrequency[i] * fftCoefficientsFrequency_[i] *
                         static_cast<float>(fftSize_);
  }

  std::vector<std::complex<float>> outputTime(fftSize_);
  WaveProcessing::inverseFourierTransform(outputFrequency, outputTime);

  for (std::size_t i = 0; i < outputBlockSize_; ++i) {
    std::complex<float> sample =
        outputTime[i] + (i < filterSize_ - 1 ? overlapBuffer_[i]
                                             : std::complex<float>(0.0f, 0.0f));
    output[i] = sample.real();
  }

  for (std::size_t i = 0; i < filterSize_ - 1; ++i) {
    overlapBuffer_[i] = outputTime[outputBlockSize_ + i];
  }
}

Upsampler2x::Upsampler2x(std::size_t blockSize)
    : Upsampler(
          {
              -5.4776569282358651e-08f, -1.7959945733991557e-07f,
              4.1240440064676782e-07f,  8.0890573408901516e-07f,
              -1.4439811482027084e-06f, -2.4160987738951988e-06f,
              3.852356105242963e-06f,   5.9141500309856959e-06f,
              -8.8034879317950675e-06f, -1.2769939414362163e-05f,
              1.811821702944141e-05f,   2.5216362559275639e-05f,
              -3.4504503527182013e-05f, -4.6504132912434091e-05f,
              6.1827854147757531e-05f,  8.1189523901447898e-05f,
              -0.000105414717533443f,   -0.00013545143716174956f,
              0.00017238098074639799f,  0.00021742889332693603f,
              -0.00027197592944999671f, -0.000337568969901598f,
              0.00041593185723707828f,  0.00050897614455143404f,
              -0.0006188117919281392f,  -0.00074775789679210438f,
              0.00089835361009840328f,  0.0010733694725623591f,
              -0.0012758195073583041f,  -0.0015089745322770993f,
              0.0017763773110491784f,   0.0020818603581997841f,
              -0.0024295674549812784f,  -0.0028239802401132321f,
              0.0032699516283132344f,   0.0037727483099225037f,
              -0.0043381052357942965f,  -0.0049722958491823449f,
              0.0056822229713967684f,   0.0064755367978850138f,
              -0.0073607885889413411f,  -0.0083476316021607738f,
              0.0094470850020804565f,   0.010671882495974708f,
              -0.012036936222087071f,   -0.013559959454762044f,
              0.015262311428463753f,    0.017170158083929202f,
              -0.019316090753758949f,   -0.021741422952386815f,
              0.02449951569507967f,     0.027660705837698616f,
              -0.031319811380827615f,   -0.035607929557376308f,
              0.040711688273328196f,    0.046906086013730995f,
              -0.054613599387065503f,   -0.064517842630877578f,
              0.077801204348121072f,    0.096699309700867278f,
              -0.12600595270958675f,    -0.17818980703686041f,
              0.29897787003943377f,     0.89993987733099334f,
              0.89993987733099334f,     0.29897787003943377f,
              -0.17818980703686041f,    -0.12600595270958675f,
              0.096699309700867278f,    0.077801204348121072f,
              -0.064517842630877578f,   -0.054613599387065503f,
              0.046906086013730995f,    0.040711688273328196f,
              -0.035607929557376308f,   -0.031319811380827615f,
              0.027660705837698616f,    0.02449951569507967f,
              -0.021741422952386815f,   -0.019316090753758949f,
              0.017170158083929202f,    0.015262311428463753f,
              -0.013559959454762044f,   -0.012036936222087071f,
              0.010671882495974708f,    0.0094470850020804565f,
              -0.0083476316021607738f,  -0.0073607885889413411f,
              0.0064755367978850138f,   0.0056822229713967684f,
              -0.0049722958491823449f,  -0.0043381052357942965f,
              0.0037727483099225037f,   0.0032699516283132344f,
              -0.0028239802401132321f,  -0.0024295674549812784f,
              0.0020818603581997841f,   0.0017763773110491784f,
              -0.0015089745322770993f,  -0.0012758195073583041f,
              0.0010733694725623591f,   0.00089835361009840328f,
              -0.00074775789679210438f, -0.0006188117919281392f,
              0.00050897614455143404f,  0.00041593185723707828f,
              -0.000337568969901598f,   -0.00027197592944999671f,
              0.00021742889332693603f,  0.00017238098074639799f,
              -0.00013545143716174956f, -0.000105414717533443f,
              8.1189523901447898e-05f,  6.1827854147757531e-05f,
              -4.6504132912434091e-05f, -3.4504503527182013e-05f,
              2.5216362559275639e-05f,  1.811821702944141e-05f,
              -1.2769939414362163e-05f, -8.8034879317950675e-06f,
              5.9141500309856959e-06f,  3.852356105242963e-06f,
              -2.4160987738951988e-06f, -1.4439811482027084e-06f,
              8.0890573408901516e-07f,  4.1240440064676782e-07f,
              -1.7959945733991557e-07f, -5.4776569282358651e-08f,
          },
          2, blockSize) {}

Upsampler4x::Upsampler4x(std::size_t blockSize)
    : Upsampler(
          {
              -2.9528611625963004e-08f, -1.3833184812965343e-07f,
              -2.328665021210672e-07f,  -1.4990011078138878e-07f,
              2.2103414707050048e-07f,  7.5765080906442335e-07f,
              1.0450844156175254e-06f,  5.8351617218646129e-07f,
              -7.717966977412316e-07f,  -2.4254917651760613e-06f,
              -3.1144002765905284e-06f, -1.6367833994337429e-06f,
              2.0549932746473549e-06f,  6.1705870788741259e-06f,
              7.6102037740940782e-06f,  3.8579940609365722e-06f,
              -4.6888169466200325e-06f, -1.3669401970630004e-05f,
              -1.6409047148207188e-05f, -8.1143138243661543e-06f,
              9.6376339728908837e-06f,  2.7503278618561149e-05f,
              3.2364711796829435e-05f,  1.5708974199544405e-05f,
              -1.8334454530683322e-05f, -5.1466673652069679e-05f,
              -5.9628778180622485e-05f, -2.8519043557672811e-05f,
              3.2823544311264512e-05f,  9.0922728401061819e-05f,
              0.00010401700377844226f,  4.9151446059181214e-05f,
              -5.5920465496991288e-05f, -0.00015319872815017132f,
              -0.00017341319974025418f, -8.1113445908748342e-05f,
              9.138544642364895e-05f,   0.00024801084932848488f,
              0.00027819938386281683f,  0.00012899272981139838f,
              -0.0001441050387283135f,  -0.00038790572644761779f,
              -0.00043169958228728183f, -0.00019864185511896272f,
              0.00022027689863184623f,  0.00058870673005904147f,
              0.00065062573649292443f,  0.00029736261100474513f,
              -0.0003275936717705959f,  -0.00086995656383685987f,
              -0.00095551893342791291f, -0.00043408828281337261f,
              0.00047542491493910756f,  0.0012553562590868715f,
              0.0013711890983127343f,   0.00061956657123948063f,
              -0.00067500145650627738f, -0.0017732156992097234f,
              -0.0019271733569320702f,  -0.0008665538951756073f,
              0.00093961556456661273f,  0.0024569550693267568f,
              0.0026582604026989648f,   0.0011900443495420274f,
              -0.0012848642748533629f,  -0.0033457342348994523f,
              -0.0036051700920016615f,  -0.0016075759176870032f,
              0.0017289847735570722f,   0.0044853450750760868f,
              0.0048155423001298801f,   0.0021396865685961901f,
              -0.0022933643856356688f,  -0.0059295930425673007f,
              -0.0063454917741984822f,  -0.0028106408716771585f,
              0.0030033620282099638f,   0.0077425429795223658f,
              0.0082621549951790892f,   0.0036496277948327854f,
              -0.003889669631261194f,   -0.010002258385577178f,
              -0.01064794802482278f,    -0.0046927707013923363f,
              0.0049906049165656732f,   0.012807121345175433f,
              0.01360778966570626f,     0.005986550702201175f,
              -0.0063560332352081269f,  -0.016286694350623906f,
              -0.017281581285027041f,   -0.0075937561838137898f,
              0.0080542281103212713f,   0.020620859537021696f,
              0.021866374670200306f,    0.0096041452326441675f,
              -0.010184287157572655f,   -0.026074829721360854f,
              -0.027657402060355302f,   -0.012154434845902617f,
              0.012899735334502373f,    0.033066721376824884f,
              0.035128577022708697f,    0.015468223488342798f,
              -0.016456581688328281f,   -0.04230803008757187f,
              -0.045103659253106526f,   -0.019942972475699809f,
              0.021320827586831407f,    0.055127033645269226f,
              0.059162792314218171f,    0.026363739577983422f,
              -0.028442639471918458f,   -0.074327869609636693f,
              -0.080772046958565491f,   -0.036527337227095141f,
              0.040102696841828864f,    0.10701299526338313f,
              0.1192660857316724f,      0.055628506464995245f,
              -0.063466386462561628f,   -0.17782542696179302f,
              -0.21120746346564076f,    -0.10737102723439343f,
              0.13850768755530418f,     0.46930923616715492f,
              0.78348149887242513f,     0.97439428966474073f,
              0.97439428966474073f,     0.78348149887242513f,
              0.46930923616715492f,     0.13850768755530418f,
              -0.10737102723439343f,    -0.21120746346564076f,
              -0.17782542696179302f,    -0.063466386462561628f,
              0.055628506464995245f,    0.1192660857316724f,
              0.10701299526338313f,     0.040102696841828864f,
              -0.036527337227095141f,   -0.080772046958565491f,
              -0.074327869609636693f,   -0.028442639471918458f,
              0.026363739577983422f,    0.059162792314218171f,
              0.055127033645269226f,    0.021320827586831407f,
              -0.019942972475699809f,   -0.045103659253106526f,
              -0.04230803008757187f,    -0.016456581688328281f,
              0.015468223488342798f,    0.035128577022708697f,
              0.033066721376824884f,    0.012899735334502373f,
              -0.012154434845902617f,   -0.027657402060355302f,
              -0.026074829721360854f,   -0.010184287157572655f,
              0.0096041452326441675f,   0.021866374670200306f,
              0.020620859537021696f,    0.0080542281103212713f,
              -0.0075937561838137898f,  -0.017281581285027041f,
              -0.016286694350623906f,   -0.0063560332352081269f,
              0.005986550702201175f,    0.01360778966570626f,
              0.012807121345175433f,    0.0049906049165656732f,
              -0.0046927707013923363f,  -0.01064794802482278f,
              -0.010002258385577178f,   -0.003889669631261194f,
              0.0036496277948327854f,   0.0082621549951790892f,
              0.0077425429795223658f,   0.0030033620282099638f,
              -0.0028106408716771585f,  -0.0063454917741984822f,
              -0.0059295930425673007f,  -0.0022933643856356688f,
              0.0021396865685961901f,   0.0048155423001298801f,
              0.0044853450750760868f,   0.0017289847735570722f,
              -0.0016075759176870032f,  -0.0036051700920016615f,
              -0.0033457342348994523f,  -0.0012848642748533629f,
              0.0011900443495420274f,   0.0026582604026989648f,
              0.0024569550693267568f,   0.00093961556456661273f,
              -0.0008665538951756073f,  -0.0019271733569320702f,
              -0.0017732156992097234f,  -0.00067500145650627738f,
              0.00061956657123948063f,  0.0013711890983127343f,
              0.0012553562590868715f,   0.00047542491493910756f,
              -0.00043408828281337261f, -0.00095551893342791291f,
              -0.00086995656383685987f, -0.0003275936717705959f,
              0.00029736261100474513f,  0.00065062573649292443f,
              0.00058870673005904147f,  0.00022027689863184623f,
              -0.00019864185511896272f, -0.00043169958228728183f,
              -0.00038790572644761779f, -0.0001441050387283135f,
              0.00012899272981139838f,  0.00027819938386281683f,
              0.00024801084932848488f,  9.138544642364895e-05f,
              -8.1113445908748342e-05f, -0.00017341319974025418f,
              -0.00015319872815017132f, -5.5920465496991288e-05f,
              4.9151446059181214e-05f,  0.00010401700377844226f,
              9.0922728401061819e-05f,  3.2823544311264512e-05f,
              -2.8519043557672811e-05f, -5.9628778180622485e-05f,
              -5.1466673652069679e-05f, -1.8334454530683322e-05f,
              1.5708974199544405e-05f,  3.2364711796829435e-05f,
              2.7503278618561149e-05f,  9.6376339728908837e-06f,
              -8.1143138243661543e-06f, -1.6409047148207188e-05f,
              -1.3669401970630004e-05f, -4.6888169466200325e-06f,
              3.8579940609365722e-06f,  7.6102037740940782e-06f,
              6.1705870788741259e-06f,  2.0549932746473549e-06f,
              -1.6367833994337429e-06f, -3.1144002765905284e-06f,
              -2.4254917651760613e-06f, -7.717966977412316e-07f,
              5.8351617218646129e-07f,  1.0450844156175254e-06f,
              7.5765080906442335e-07f,  2.2103414707050048e-07f,
              -1.4990011078138878e-07f, -2.328665021210672e-07f,
              -1.3833184812965343e-07f, -2.9528611625963004e-08f,
          },
          4, blockSize) {}
} // namespace web_audio::detail