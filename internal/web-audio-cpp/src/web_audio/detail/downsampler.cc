#include "web_audio/detail/downsampler.hh"

#include "web_audio/detail/math_helper.hh"
#include "web_audio/detail/wave_processing.hh"

namespace web_audio::detail {
Downsampler::Downsampler(const std::vector<float> &filterCoefficients,
                         std::size_t factor, std::size_t blockSize)
    : factor_(factor), inputBlockSize_(blockSize) {
  filterCoefficients_ = filterCoefficients;

  outputBlockSize_ = inputBlockSize_ / factor_;
  filterSize_ = filterCoefficients_.size();
  fftSize_ = MathHelper::nextPowerOfTwo(inputBlockSize_ + filterSize_ - 1);
  filterCoefficients_.resize(fftSize_, 0.0f);
  fftCoefficientsFrequency_.resize(fftSize_);
  overlapBuffer_.resize(filterSize_ - 1, std::complex<float>(0.0f, 0.0f));

  WaveProcessing::fourierTransform(filterCoefficients_,
                                   fftCoefficientsFrequency_);
}

void Downsampler::process(const std::vector<float> &input,
                          std::vector<float> &output) {
  if (input.size() != inputBlockSize_) {
    throw std::invalid_argument("Input size must be equal to block size.");
  }

  output.resize(outputBlockSize_);

  std::vector<float> inputPadded(fftSize_, 0.0f);
  std::copy(input.begin(), input.end(), inputPadded.begin());

  std::vector<std::complex<float>> inputFrequency(fftSize_);
  WaveProcessing::fourierTransform(inputPadded, inputFrequency);

  std::vector<std::complex<float>> outputFrequency(fftSize_);

  for (std::size_t i = 0; i < fftSize_; ++i) {
    outputFrequency[i] = inputFrequency[i] * fftCoefficientsFrequency_[i] *
                         static_cast<float>(fftSize_);
  }

  std::vector<std::complex<float>> outputTime(fftSize_);
  WaveProcessing::inverseFourierTransform(outputFrequency, outputTime);

  for (std::size_t i = 0; i < outputBlockSize_; ++i) {
    std::complex<float> sample =
        outputTime[i * factor_] + (i * factor_ < filterSize_ - 1
                                       ? overlapBuffer_[i * factor_]
                                       : std::complex<float>(0.0f, 0.0f));
    output[i] = sample.real();
  }

  for (std::size_t i = 0; i < filterSize_ - 1; ++i) {
    overlapBuffer_[i] = outputTime[outputBlockSize_ + i];
  }
}

Downsampler2x::Downsampler2x(std::size_t blockSize)
    : Downsampler(
          {
              -2.7388284641179326e-08f, -8.9799728669957787e-08f,
              2.0620220032338391e-07f,  4.0445286704450758e-07f,
              -7.219905741013542e-07f,  -1.2080493869475994e-06f,
              1.9261780526214815e-06f,  2.9570750154928479e-06f,
              -4.4017439658975338e-06f, -6.3849697071810814e-06f,
              9.0591085147207052e-06f,  1.2608181279637819e-05f,
              -1.7252251763591007e-05f, -2.3252066456217045e-05f,
              3.0913927073878765e-05f,  4.0594761950723949e-05f,
              -5.2707358766721499e-05f, -6.7725718580874782e-05f,
              8.6190490373198997e-05f,  0.00010871444666346802f,
              -0.00013598796472499836f, -0.000168784484950799f,
              0.00020796592861853914f,  0.00025448807227571702f,
              -0.0003094058959640696f,  -0.00037387894839605219f,
              0.00044917680504920164f,  0.00053668473628117953f,
              -0.00063790975367915205f, -0.00075448726613854965f,
              0.00088818865552458919f,  0.0010409301790998921f,
              -0.0012147837274906392f,  -0.001411990120056616f,
              0.0016349758141566172f,   0.0018863741549612519f,
              -0.0021690526178971483f,  -0.0024861479245911725f,
              0.0028411114856983842f,   0.0032377683989425069f,
              -0.0036803942944706705f,  -0.0041738158010803869f,
              0.0047235425010402282f,   0.005335941247987354f,
              -0.0060184681110435354f,  -0.0067799797273810219f,
              0.0076311557142318765f,   0.0085850790419646009f,
              -0.0096580453768794743f,  -0.010870711476193408f,
              0.012249757847539835f,    0.013830352918849308f,
              -0.015659905690413808f,   -0.017803964778688154f,
              0.020355844136664098f,    0.023453043006865498f,
              -0.027306799693532752f,   -0.032258921315438789f,
              0.038900602174060536f,    0.048349654850433639f,
              -0.063002976354793377f,   -0.089094903518430205f,
              0.14948893501971688f,     0.44996993866549667f,
              0.44996993866549667f,     0.14948893501971688f,
              -0.089094903518430205f,   -0.063002976354793377f,
              0.048349654850433639f,    0.038900602174060536f,
              -0.032258921315438789f,   -0.027306799693532752f,
              0.023453043006865498f,    0.020355844136664098f,
              -0.017803964778688154f,   -0.015659905690413808f,
              0.013830352918849308f,    0.012249757847539835f,
              -0.010870711476193408f,   -0.0096580453768794743f,
              0.0085850790419646009f,   0.0076311557142318765f,
              -0.0067799797273810219f,  -0.0060184681110435354f,
              0.005335941247987354f,    0.0047235425010402282f,
              -0.0041738158010803869f,  -0.0036803942944706705f,
              0.0032377683989425069f,   0.0028411114856983842f,
              -0.0024861479245911725f,  -0.0021690526178971483f,
              0.0018863741549612519f,   0.0016349758141566172f,
              -0.001411990120056616f,   -0.0012147837274906392f,
              0.0010409301790998921f,   0.00088818865552458919f,
              -0.00075448726613854965f, -0.00063790975367915205f,
              0.00053668473628117953f,  0.00044917680504920164f,
              -0.00037387894839605219f, -0.0003094058959640696f,
              0.00025448807227571702f,  0.00020796592861853914f,
              -0.000168784484950799f,   -0.00013598796472499836f,
              0.00010871444666346802f,  8.6190490373198997e-05f,
              -6.7725718580874782e-05f, -5.2707358766721499e-05f,
              4.0594761950723949e-05f,  3.0913927073878765e-05f,
              -2.3252066456217045e-05f, -1.7252251763591007e-05f,
              1.2608181279637819e-05f,  9.0591085147207052e-06f,
              -6.3849697071810814e-06f, -4.4017439658975338e-06f,
              2.9570750154928479e-06f,  1.9261780526214815e-06f,
              -1.2080493869475994e-06f, -7.219905741013542e-07f,
              4.0445286704450758e-07f,  2.0620220032338391e-07f,
              -8.9799728669957787e-08f, -2.7388284641179326e-08f,
          },
          2, blockSize) {}

Downsampler4x::Downsampler4x(std::size_t blockSize)
    : Downsampler(
          {
              -7.3821529064907509e-09f, -3.4582962032413357e-08f,
              -5.8216625530266799e-08f, -3.7475027695347195e-08f,
              5.525853676762512e-08f,   1.8941270226610584e-07f,
              2.6127110390438135e-07f,  1.4587904304661532e-07f,
              -1.929491744353079e-07f,  -6.0637294129401532e-07f,
              -7.7860006914763211e-07f, -4.0919584985843572e-07f,
              5.1374831866183871e-07f,  1.5426467697185315e-06f,
              1.9025509435235195e-06f,  9.6449851523414304e-07f,
              -1.1722042366550081e-06f, -3.4173504926575009e-06f,
              -4.102261787051797e-06f,  -2.0285784560915386e-06f,
              2.4094084932227209e-06f,  6.8758196546402873e-06f,
              8.0911779492073588e-06f,  3.9272435498861012e-06f,
              -4.5836136326708306e-06f, -1.286666841301742e-05f,
              -1.4907194545155621e-05f, -7.1297608894182028e-06f,
              8.205886077816128e-06f,   2.2730682100265455e-05f,
              2.6004250944610564e-05f,  1.2287861514795303e-05f,
              -1.3980116374247822e-05f, -3.8299682037542831e-05f,
              -4.3353299935063544e-05f, -2.0278361477187085e-05f,
              2.2846361605912237e-05f,  6.200271233212122e-05f,
              6.9549845965704207e-05f,  3.2248182452849595e-05f,
              -3.6026259682078375e-05f, -9.6976431611904448e-05f,
              -0.00010792489557182046f, -4.9660463779740681e-05f,
              5.5069224657961556e-05f,  0.00014717668251476037f,
              0.00016265643412323111f,  7.4340652751186284e-05f,
              -8.1898417942648976e-05f, -0.00021748914095921497f,
              -0.00023887973335697823f, -0.00010852207070334315f,
              0.00011885622873477689f,  0.00031383906477171788f,
              0.00034279727457818359f,  0.00015489164280987016f,
              -0.00016875036412656935f, -0.00044330392480243085f,
              -0.00048179333923301754f, -0.00021663847379390183f,
              0.00023490389114165318f,  0.00061423876733168921f,
              0.00066456510067474121f,  0.00029751108738550685f,
              -0.00032121606871334072f, -0.00083643355872486307f,
              -0.00090129252300041537f, -0.0004018939794217508f,
              0.00043224619338926804f,  0.0011213362687690217f,
              0.00120388557503247f,     0.00053492164214904753f,
              -0.0005733410964089172f,  -0.0014823982606418252f,
              -0.0015863729435496206f,  -0.00070266021791928963f,
              0.00075084050705249094f,  0.0019356357448805915f,
              0.0020655387487947723f,   0.00091240694870819636f,
              -0.00097241740781529851f, -0.0025005645963942945f,
              -0.002661987006205695f,   -0.0011731926753480841f,
              0.0012476512291414183f,   0.0032017803362938582f,
              0.0034019474164265649f,   0.0014966376755502938f,
              -0.0015890083088020317f,  -0.0040716735876559764f,
              -0.0043203953212567602f,  -0.0018984390459534475f,
              0.0020135570275803178f,   0.0051552148842554241f,
              0.0054665936675500765f,   0.0024010363081610419f,
              -0.0025460717893931637f,  -0.0065187074303402134f,
              -0.0069143505150888254f,  -0.0030386087114756544f,
              0.0032249338336255932f,   0.008266680344206221f,
              0.0087821442556771743f,   0.0038670558720856995f,
              -0.0041141454220820703f,  -0.010577007521892967f,
              -0.011275914813276632f,   -0.0049857431189249523f,
              0.0053302068967078517f,   0.013781758411317306f,
              0.014790698078554543f,    0.0065909348944958555f,
              -0.0071106598679796145f,  -0.018581967402409173f,
              -0.020193011739641373f,   -0.0091318343067737853f,
              0.010025674210457216f,    0.026753248815845784f,
              0.029816521432918099f,    0.013907126616248811f,
              -0.015866596615640407f,   -0.044456356740448254f,
              -0.05280186586641019f,    -0.026842756808598357f,
              0.034626921888826045f,    0.11732730904178873f,
              0.19587037471810628f,     0.24359857241618518f,
              0.24359857241618518f,     0.19587037471810628f,
              0.11732730904178873f,     0.034626921888826045f,
              -0.026842756808598357f,   -0.05280186586641019f,
              -0.044456356740448254f,   -0.015866596615640407f,
              0.013907126616248811f,    0.029816521432918099f,
              0.026753248815845784f,    0.010025674210457216f,
              -0.0091318343067737853f,  -0.020193011739641373f,
              -0.018581967402409173f,   -0.0071106598679796145f,
              0.0065909348944958555f,   0.014790698078554543f,
              0.013781758411317306f,    0.0053302068967078517f,
              -0.0049857431189249523f,  -0.011275914813276632f,
              -0.010577007521892967f,   -0.0041141454220820703f,
              0.0038670558720856995f,   0.0087821442556771743f,
              0.008266680344206221f,    0.0032249338336255932f,
              -0.0030386087114756544f,  -0.0069143505150888254f,
              -0.0065187074303402134f,  -0.0025460717893931637f,
              0.0024010363081610419f,   0.0054665936675500765f,
              0.0051552148842554241f,   0.0020135570275803178f,
              -0.0018984390459534475f,  -0.0043203953212567602f,
              -0.0040716735876559764f,  -0.0015890083088020317f,
              0.0014966376755502938f,   0.0034019474164265649f,
              0.0032017803362938582f,   0.0012476512291414183f,
              -0.0011731926753480841f,  -0.002661987006205695f,
              -0.0025005645963942945f,  -0.00097241740781529851f,
              0.00091240694870819636f,  0.0020655387487947723f,
              0.0019356357448805915f,   0.00075084050705249094f,
              -0.00070266021791928963f, -0.0015863729435496206f,
              -0.0014823982606418252f,  -0.0005733410964089172f,
              0.00053492164214904753f,  0.00120388557503247f,
              0.0011213362687690217f,   0.00043224619338926804f,
              -0.0004018939794217508f,  -0.00090129252300041537f,
              -0.00083643355872486307f, -0.00032121606871334072f,
              0.00029751108738550685f,  0.00066456510067474121f,
              0.00061423876733168921f,  0.00023490389114165318f,
              -0.00021663847379390183f, -0.00048179333923301754f,
              -0.00044330392480243085f, -0.00016875036412656935f,
              0.00015489164280987016f,  0.00034279727457818359f,
              0.00031383906477171788f,  0.00011885622873477689f,
              -0.00010852207070334315f, -0.00023887973335697823f,
              -0.00021748914095921497f, -8.1898417942648976e-05f,
              7.4340652751186284e-05f,  0.00016265643412323111f,
              0.00014717668251476037f,  5.5069224657961556e-05f,
              -4.9660463779740681e-05f, -0.00010792489557182046f,
              -9.6976431611904448e-05f, -3.6026259682078375e-05f,
              3.2248182452849595e-05f,  6.9549845965704207e-05f,
              6.200271233212122e-05f,   2.2846361605912237e-05f,
              -2.0278361477187085e-05f, -4.3353299935063544e-05f,
              -3.8299682037542831e-05f, -1.3980116374247822e-05f,
              1.2287861514795303e-05f,  2.6004250944610564e-05f,
              2.2730682100265455e-05f,  8.205886077816128e-06f,
              -7.1297608894182028e-06f, -1.4907194545155621e-05f,
              -1.286666841301742e-05f,  -4.5836136326708306e-06f,
              3.9272435498861012e-06f,  8.0911779492073588e-06f,
              6.8758196546402873e-06f,  2.4094084932227209e-06f,
              -2.0285784560915386e-06f, -4.102261787051797e-06f,
              -3.4173504926575009e-06f, -1.1722042366550081e-06f,
              9.6449851523414304e-07f,  1.9025509435235195e-06f,
              1.5426467697185315e-06f,  5.1374831866183871e-07f,
              -4.0919584985843572e-07f, -7.7860006914763211e-07f,
              -6.0637294129401532e-07f, -1.929491744353079e-07f,
              1.4587904304661532e-07f,  2.6127110390438135e-07f,
              1.8941270226610584e-07f,  5.525853676762512e-08f,
              -3.7475027695347195e-08f, -5.8216625530266799e-08f,
              -3.4582962032413357e-08f, -7.3821529064907509e-09f,
          },
          4, blockSize) {}
} // namespace web_audio::detail